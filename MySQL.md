# MySQL

## 数据库的结构

页是MySQL中磁盘和内存交互的基本单位，也是MySQL管理存储空间的基本单位，
页的大小通常是16KB，可输入
`show variables like "innodb_page_size"`
查看当前设置页的大小

每个页中存放着我们的数据，即一行行的记录。MySQL中行记录的种类共有四种，分别是
`compact`,
`redundant`,
`dynamic`,
`compact`,
可输入`show variables like "innodb_default_row_format"`
查看默认行格式

行记录由两个部分组成，分别是额外信息和真实数据，额外信息一般包括变长字段长度列表，NULL值列表和记录头信息，而真实数据则是记录中每个字段的值，加上三个隐藏列，分别为`DB_ROW_ID`,`DB_TRX_ID`,`DB_ROLL_PTR`
其中，如果用户定义了主键或是`unique`键，则MySQL不会默认生成`DB_ROW_ID`

当记录中的数据太多，一页无法存放下，会讲数据分散存储到其他页中，这种情况是**行溢出**


innodb有不同类型的页，存放记录行的页为**数据页**

每个数据页可以被分成七个部分：
+ File Header 表示页的一些通用信息
+ Page Header 表示数据页的一些专有信息
+ Infimum + Supremum 虚拟的最大记录和最小记录
+ User Records 存放记录
+ Free Space 还未使用的空间
+ Page Directory 记录各个槽的相对位置
+ File Trailer 用于检验页是否完整的部分

每个记录的头信息有一个`next_record`的属性，用于指向下一条记录，所有记录形成
单链表，Infimum的下一条记录为页中的第一条记录，而Supermum为最后一条记录。

为了加快查询记录的速度，将数据页的记录分成不同的组，每组最后一个记录的地址偏移量作为一个槽，进行查询时，
先通过二分法查找该记录所在的槽，再遍历槽中的记录

每个数据页的File Header部分都有上一个和下一个页的编号，所以所有的数据页会组成一个**双链表**。


## 数据库的索引

### 1.数据库的三大范式
+ 第一范式：确保每列保持原子性，数据表中的所有字段值都是不可分解的原子值
+ 第二范式：确保表中的每列都和主键相关
+ 第三范式：确保每列都和主键列直接相关而不是间接相关

### 2.索引的优缺点
+ 优点
    + 大大加快数据检索的速度
    + 将随机I/O变成顺序I/O(因为B+树的叶子节点是连接在一起的)
    + 加速表与表之间的连接
+ 缺点
    + 从空间角度考虑，建立索引需要占用物理空间
    + 从时间角度考虑，创建和维护索引都需要花费时间，例如对数据进行增删改的时候都需要维护索引。

### 3.Hash索引和B+树索引
+ 哈希索引不支持排序，因为哈希表是无序的
+ 哈希索引不支持范围查找
+ 哈希索引不支持模糊查询及多列索引的最左前缀匹配
+ 因为哈希表中会存在哈希冲突，所以哈希索引的性能是不稳定的，而B+树索引的性能是相对稳定的，每次查询都是从根节点到叶子节点

### 4.什么是聚簇索引？什么是非聚簇索引
+ 聚簇索引将数据和索引放到一起存储，索引结构的叶子节点保存数据行
+ 非聚簇索引将数据和索引分开存储，索引结构的叶子节点保存指向数据行的地址

## 数据库的事务

### 1.什么是数据库的事务?

数据库事务是一系列数据库操作，这些操作要么全部执行,要么全部不执行，是一个不可分割的工作单位。

### 2.事物的四大特性

+ 原子性：原子性是指包含事务的操作要么全部执行成功，要么全部失败回滚
+ 一致性：一致性指事务在执行前后状态是一致的
+ 隔离性：一个事务所进行的修改在最终提交之前，对其他事务是不可见的
+ 持久性：数据一旦提交，其所作的修改将永久地保存到数据库中

### 3.数据库的并发一致性问题

+ 脏读：事务A更新了数据，但还没有提交，这时事务B读取到事务A更新后的数据，然后事务A回滚了，事务B读取到的数据就成为脏数据了
+ 不可重复读：事务A对数据进行多次读取，事务B在事务A多次读取的过程中执行了更新操作并提交了，导致事务A多次读取到的数据并不一致
+ 幻读：事务A在读取数据后，事务B向事务A读取的数据中插入了几条数据，事务A再次读取数据时发现多了几条数据，和之前读取的数据不一致
+ 丢失修改：事务A和事务B都对同一个数据进行修改，事务A先修改，事务B随后修改，事务B的修改覆盖了事务A的修改

### 4.数据库的隔离级别

MySQL的默认隔离级别是可重复读
+ 未提交读：一个事务在提交前，它的修改对其他事务也是可见的
+ 提交读：一个事务提交之后，它的修改才能被其他事务看到
+ 可重复读：在同一个事务中多次读取到的数据是一致的
+ 串行化：需要加锁实现，会强制事务串行执行
